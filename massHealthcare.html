<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Massachusetts Healthcare System — Interactive Map</title>
  <style>
    :root{
      --bg:#0b1220; --panel:#0f1a33; --card:#122042;
      --text:#e8eefc; --muted:#a8b3d6; --line:rgba(255,255,255,.16);
      --accent:#93c5fd;
    }
    html,body{height:100%;margin:0;font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; background:var(--bg); color:var(--text);}
    .app{display:grid; grid-template-columns: 420px 1fr; height:100%;}
    .side{
      overflow:auto; padding:14px; border-right:1px solid var(--line);
      background:linear-gradient(180deg, rgba(15,26,51,.98), rgba(15,26,51,.72));
    }
    .main{position:relative; overflow:hidden;}
    .top{display:flex; gap:10px; align-items:center; justify-content:space-between;}
    h1{font-size:16px; margin:0; letter-spacing:.2px;}
    .sub{margin:8px 0 12px; font-size:12px; color:var(--muted); line-height:1.35;}
    .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
    button, .chip{
      background:rgba(255,255,255,.05);
      border:1px solid var(--line);
      color:var(--text);
      border-radius:12px;
      padding:8px 10px;
      cursor:pointer;
      user-select:none;
    }
    button:hover{background:rgba(255,255,255,.08);}
    .chip{display:inline-flex; gap:8px; align-items:center; padding:7px 10px; font-size:12px;}
    .dot{width:10px;height:10px;border-radius:999px;display:inline-block;}
    .card{
      background:rgba(255,255,255,.04);
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
      margin:12px 0;
    }
    .card h2{
      margin:0 0 10px;
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:.12em;
      color:var(--muted);
      display:flex; align-items:center; justify-content:space-between;
    }
    .search{
      width:100%;
      box-sizing:border-box;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      color:var(--text);
      outline:none;
    }
    .hint{font-size:12px;color:var(--muted);line-height:1.4;margin:8px 0 0;}
    details{
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px 10px;
      background:rgba(255,255,255,.03);
      margin:8px 0;
    }
    summary{cursor:pointer; font-weight:650; list-style:none;}
    summary::-webkit-details-marker{display:none;}
    .meta{margin-top:8px; font-size:12px; color:var(--muted); line-height:1.45;}
    .pill{
      display:inline-block; font-size:11px; padding:3px 8px;
      border-radius:999px; border:1px solid var(--line); color:var(--muted);
      margin:0 6px 6px 0;
    }
    .selTitle{font-size:15px; font-weight:780; margin:2px 0 6px;}
    .selBody{font-size:12.5px; line-height:1.55; white-space:pre-wrap;}
    .kv{margin-top:10px; font-size:12px; color:var(--muted); line-height:1.45;}
    .kv b{color:var(--text);}
    .list{margin:8px 0 0; padding-left:18px; color:var(--text); font-size:12.5px; line-height:1.45;}
    .footer{margin-top:10px; font-size:11px; color:var(--muted); line-height:1.4;}
    a{color:#b9d2ff;}

    /* SVG */
    svg{width:100%;height:100%;display:block;}

    /* Links: color-coded by LINK TYPE (payment / policy / data / care / industry / nonprofit) */
    .link{stroke-width:1.35; opacity:0.92;}
    .link.strong{stroke-width:2.35;}
    .link.faded{opacity:.10;}
    .link.payment{stroke: rgba(134,239,172,.85);}   /* green */
    .link.policy{stroke: rgba(252,165,165,.85);}    /* red */
    .link.data{stroke: rgba(125,211,252,.85);}      /* sky */
    .link.care{stroke: rgba(196,181,253,.85);}      /* violet */
    .link.industry{stroke: rgba(253,186,116,.85);}  /* orange */
    .link.nonprofit{stroke: rgba(147,197,253,.92);} /* blue */

    /* Link labels: match link type color, but keep readable via halo stroke */
    .linkLabel{
      font-size:11px;
      pointer-events:none;
      paint-order: stroke;
      stroke: rgba(0,0,0,.55);
      stroke-width: 3px;
      stroke-linejoin: round;
    }
    .linkLabel.payment{fill: rgba(134,239,172,.95);}
    .linkLabel.policy{fill: rgba(252,165,165,.95);}
    .linkLabel.data{fill: rgba(125,211,252,.95);}
    .linkLabel.care{fill: rgba(196,181,253,.95);}
    .linkLabel.industry{fill: rgba(253,186,116,.95);}
    .linkLabel.nonprofit{fill: rgba(147,197,253,.98);}

    .node{cursor:grab;}
    .node:active{cursor:grabbing;}
    .node circle{stroke:rgba(255,255,255,.25);stroke-width:1.25;}
    .node circle.faded{opacity:.18;}
    .node circle.selected{stroke:white; stroke-width:3;}
    .label{
      fill:var(--text);
      font-size:12px;
      paint-order: stroke;
      stroke: rgba(0,0,0,.38);
      stroke-width: 3px;
    }
    .label.faded{opacity:.18;}

    .toolbar{
      position:absolute; left:14px; top:14px; display:flex; gap:8px; flex-wrap:wrap;
      background:rgba(15,26,51,.55); border:1px solid var(--line); border-radius:14px;
      padding:10px; backdrop-filter: blur(8px);
    }
  </style>
</head>
<body>
<div class="app">
  <aside class="side">
    <div class="top">
      <h1>Massachusetts Healthcare System — Interactive Map</h1>
      <button id="resetBtn" title="Reset view">Reset</button>
    </div>
    <div class="sub">
      Drag circles • Scroll to zoom • Drag background to pan • Click a circle to see what it is, what it wants, and how it connects.
      <div style="margin-top:6px">
        <span class="pill">Goal:</span> make this understandable even if you’ve never heard healthcare terms before.
      </div>
    </div>

     <div class="card">
      <h2>Selected circle <span class="pill" id="selCat">none</span></h2>
      <div class="selTitle" id="selTitle">Nothing selected</div>
      <div class="selBody" id="selBody"><span style="color:var(--muted)">Click a circle to open details here.</span></div>
      <div class="kv" id="selConn"></div>
    </div>

    <div class="card">
      <h2>Search <span class="pill">highlights matches</span></h2>
      <input id="search" class="search" placeholder="Try: MGB, MassHealth, CCH, insurers, regulators, community clinics..." />
      <div class="hint">Tip: search matches names, categories, and IDs (like “CCH”, “HPC”, “CHIA”).</div>
    </div>

    <div class="card">
      <h2>Categories <span class="pill">what they do + what they care about</span></h2>
      <div id="categoryAccordions"></div>
    </div>

    <div class="card">
      <h2>Legend <span class="pill">toggle layers</span></h2>
      <div class="row" id="legend"></div>
      <div class="hint" style="margin-top:10px;">
        Click a category chip to show/hide that layer.
      </div>

      <div class="hint" style="margin-top:10px;">
        <b>Line colors mean:</b>
        <span class="pill">green = money/payment</span>
        <span class="pill">red = rules/oversight</span>
        <span class="pill">sky = data/reporting</span>
        <span class="pill">violet = care/referrals</span>
        <span class="pill">orange = research/industry</span>
        <span class="pill">blue = nonprofit partnership</span>
      </div>
    </div>

    <div class="card">
      <h2>How to extend <span class="pill">edit DATA</span></h2>
      <div class="meta">
        Scroll down in this file to the <b>DATA</b> section to add circles (nodes) and lines (links).<br/>
        Keep text short, simple, and specific. If you use an acronym, explain it once.
      </div>
      <div class="footer">
        Hosting without downloads (viewers): put this file on <b>GitHub Pages</b> (free).
      </div>
    </div>
  </aside>

  <main class="main">
    <div class="toolbar">
      <button id="fitBtn">Fit to screen</button>
      <button id="freezeBtn" data-freeze="0">Freeze layout</button>
      <button id="clearSelBtn">Clear selection</button>
      <span class="chip"><span class="dot" style="background:var(--accent)"></span><span id="status">Ready</span></span>
    </div>
    <svg id="svg" viewBox="0 0 1400 900" aria-label="Interactive graph map"></svg>
  </main>
</div>

<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
<script>
/* =========================================================
   DATA (PLAIN-LANGUAGE VERSION)
   ---------------------------------------------------------
   This map shows:
   - Who provides care (hospitals, clinics, behavioral health)
   - Who pays (insurance + government programs)
   - Who sets rules / watches costs (regulators)
   - Who provides data (reporting agencies)
   - Who funds / partners (nonprofits + philanthropy)
   ========================================================= */

/* --- Link type colors (lines + line labels) --- */
const LINK_TYPES = [
  { key:"payment",  label:"Money / payment",        css:"payment"  },
  { key:"policy",   label:"Rules / oversight",      css:"policy"   },
  { key:"data",     label:"Data / reporting",       css:"data"     },
  { key:"care",     label:"Care / referrals",       css:"care"     },
  { key:"industry", label:"Research / industry",    css:"industry" },
  { key:"nonprofit",label:"Nonprofit partnership",  css:"nonprofit"}
];
const linkTypeCss = new Map(LINK_TYPES.map(x => [x.key, x.css]));

/* --- Categories (node colors) --- */
const CATEGORIES = [
  { key:"Hospitals & Health Systems", color:"#7dd3fc",
    job:"Run hospitals and clinics; provide specialty care; train clinicians; do research.",
    incentives:[
      "Help patients get better outcomes and safer care",
      "Keep services running (staffing, beds, clinics)",
      "Bring in enough revenue to sustain care and research",
      "Reduce preventable hospital stays and paperwork burden",
      "Partner on programs that improve care for underserved communities (fits CCH mission)"
    ]
  },
  { key:"Insurance Companies (Commercial)", color:"#86efac",
    job:"Collect premiums and pay for covered care; build networks; set rules like prior authorization.",
    incentives:[
      "Keep monthly costs affordable for members and employers",
      "Reduce avoidable ER visits and hospital stays",
      "Support programs that show measurable results (health + cost)",
      "Make care easier to navigate (fewer delays, clearer rules)",
      "Partner on whole-person approaches if outcomes are credible (fits CCH mission)"
    ]
  },
  { key:"Government Coverage Programs", color:"#34d399",
    job:"Public insurance programs that pay for care (for example Medicaid in MA is called MassHealth).",
    incentives:[
      "Improve access to care for people with fewer resources",
      "Reduce avoidable emergencies and hospital stays",
      "Pay for models that improve outcomes (especially underserved communities)",
      "Support equity: better care regardless of income, race, or ZIP code",
      "Scale proven whole-person healing models (aligned with CCH mission)"
    ]
  },
  { key:"Government & Regulators", color:"#fca5a5",
    job:"Set rules, watch costs, protect consumers, and publish public information.",
    incentives:[
      "Keep healthcare cost growth under control without harming quality",
      "Increase transparency so the public can see what’s happening",
      "Protect patients (access, fairness, safety)",
      "Avoid sudden system shocks while allowing useful innovation",
      "Encourage evidence-based whole-person programs that improve equity (CCH-aligned)"
    ]
  },
  { key:"Community Clinics & Safety-Net Care", color:"#c4b5fd",
    job:"Provide primary care and support services for people who might otherwise struggle to get care (often called community health centers).",
    incentives:[
      "Make care accessible (appointments, language, trust, transportation help)",
      "Prevent crises by keeping people connected to regular care",
      "Keep clinics staffed and financially stable",
      "Coordinate medical + social supports",
      "Partner with nonprofits like CCH to expand whole-person services"
    ]
  },
  { key:"Mental Health & Substance Use Care", color:"#f9a8d4",
    job:"Provide therapy, psychiatry, crisis care, and substance use treatment and recovery supports.",
    incentives:[
      "Reduce crisis situations and improve day-to-day functioning",
      "Increase capacity (more clinicians, shorter waits)",
      "Integrate with primary care so people don’t fall through gaps",
      "Sustain funding for time-intensive, relationship-based care",
      "Work with CCH-style models that support the whole person"
    ]
  },
  { key:"Rehab, Nursing, Home Care & Long-Term Supports", color:"#fda4af",
    job:"Help people recover after illness/injury, and support older adults or people with disabilities at home or in facilities.",
    incentives:[
      "Prevent hospital readmissions by supporting recovery",
      "Maintain workforce and capacity (beds, home visits)",
      "Coordinate smooth transitions from hospital to home",
      "Keep people independent and safe as long as possible",
      "Collaborate on whole-person recovery plans (CCH-aligned)"
    ]
  },
  { key:"Biotech / Pharma / Medical Devices", color:"#fdba74",
    job:"Develop medicines and devices; run studies; bring new treatments to market.",
    incentives:[
      "Prove treatments work and are safe",
      "Get coverage and adoption (patients can access them)",
      "Partner with hospitals for research and credibility",
      "Support better outcomes measurement (including patient-reported outcomes)",
      "Collaborate when whole-person care improves real-world results"
    ]
  },
  { key:"Employers (People Who Buy Insurance for Workers)", color:"#fcd34d",
    job:"Choose and pay for health insurance for employees; influence plan design.",
    incentives:[
      "Keep costs predictable and affordable",
      "Support a healthier workforce (less time away from work)",
      "Prefer programs with clear accountability and outcomes",
      "Reduce frustration for employees navigating care",
      "Offer benefits that improve whole-person wellbeing if results are measurable"
    ]
  },
  { key:"Patients, Families & Frontline Clinicians", color:"#93c5fd",
    job:"People who use the system and the staff who deliver care day-to-day.",
    incentives:[
      "Care that actually helps: relief, function, dignity, affordability",
      "Shorter waits and fewer confusing steps",
      "Trust, continuity, and culturally respectful care",
      "Less burnout and more time for relationship-based care",
      "Programs like CCH that focus on whole-person healing and access"
    ]
  },
  { key:"Nonprofits & Philanthropy", color:"#60a5fa",
    job:"Fund, test, and scale programs that improve health—especially for underserved communities—without seeking profit.",
    incentives:[
      "Expand access to care in underserved communities",
      "Prove what works through practical research and shared learning",
      "Train clinicians and students in whole-person care",
      "Build partnerships that last beyond a single grant",
      "Measure outcomes that matter to people (including patient-reported outcomes)"
    ]
  }
];

// Helper map for colors + category meta
const catMeta = new Map(CATEGORIES.map(c => [c.key, c]));
const catColor = k => (catMeta.get(k)?.color || "#ffffff");

/* --- Nodes (circles) --- */
const nodes = [
  // Hospitals & health systems
  node("MGB","Mass General Brigham (MGB)","Hospitals & Health Systems",
`WHAT THIS IS
- A large group of hospitals and clinics in Massachusetts. (Think: many care sites under one umbrella.)

WHAT THEY DO
- Provide hospital care, specialty care, research, and training.

WHAT THEY CARE ABOUT (in simple terms)
- Great outcomes and safety for patients
- Enough funding/staff to keep care running
- Partnerships that improve care for underserved communities

HOW CCH FITS
- CCH is a collaboration with MGB to advance whole-person healing through research, education, and access.`),

  node("BILH","Beth Israel Lahey Health (BILH)","Hospitals & Health Systems",
`WHAT THIS IS
- A network of hospitals and clinics.

WHAT THEY DO
- Provide a mix of primary care and hospital care.

WHAT THEY CARE ABOUT
- Reliable access and quality
- Efficient operations (less waste, more time with patients)
- Proven programs that reduce avoidable hospital visits`),

  node("TuftsMed","Tufts Medicine","Hospitals & Health Systems",
`WHAT THIS IS
- A hospital and clinic network.

WHAT THEY DO
- Provide hospital and outpatient care.

WHAT THEY CARE ABOUT
- Sustainable operations
- Programs that improve outcomes and reduce avoidable utilization
- Partnerships that support equity and access`),

  node("BCH","Boston Children’s Hospital","Hospitals & Health Systems",
`WHAT THIS IS
- A pediatric specialty hospital.

WHAT THEY DO
- Complex care for children + research.

WHAT THEY CARE ABOUT
- Excellent outcomes for kids and families
- Access to specialty care
- Family-centered supports (including mental health)`),

  node("DFCI","Dana-Farber Cancer Institute","Hospitals & Health Systems",
`WHAT THIS IS
- A cancer specialty hospital and research institute.

WHAT THEY DO
- Cancer care, clinical trials, and research.

WHAT THEY CARE ABOUT
- Better cancer outcomes and patient experience
- Evidence-based supportive care (symptoms, stress, function)`),

  // Insurance (commercial)
  node("BCBSMA","Blue Cross Blue Shield of Massachusetts (BCBSMA)","Insurance Companies (Commercial)",
`WHAT THIS IS
- A major insurance company that pays for care using member premiums.

WHAT THEY DO
- Build provider networks and pay bills for covered services.

WHAT THEY CARE ABOUT
- Keeping costs affordable
- Avoiding unnecessary ER visits and hospital stays
- Programs with measurable results (health + cost)`),

  node("Point32","Point32Health (Harvard Pilgrim / Tufts Health Plan)","Insurance Companies (Commercial)",
`WHAT THIS IS
- Another major insurance company in Massachusetts.

WHAT THEY DO
- Pays for care and designs coverage rules.

WHAT THEY CARE ABOUT
- Better outcomes for members
- Smarter use of care (right care, right place)
- Evidence that programs reduce crises and improve wellbeing`),

  // Government coverage programs
  node("MassHealth","MassHealth (Massachusetts Medicaid)","Government Coverage Programs",
`WHAT THIS IS
- Massachusetts’ public insurance for people with lower income, some families, and people with disabilities.

WHAT THEY DO
- Pays for care and sets program rules.

WHAT THEY CARE ABOUT
- Access to care and equity
- Reducing avoidable emergencies and hospital stays
- Scaling programs that work across communities`),

  node("Medicare","Medicare (Federal program)","Government Coverage Programs",
`WHAT THIS IS
- Federal health coverage mainly for people 65+ (and some younger people with disabilities).

WHAT THEY DO
- Pays for care nationwide and sets many payment rules.

WHAT THEY CARE ABOUT
- Better outcomes and safer care
- Controlling long-term cost growth
- Supporting proven care models for chronic conditions`),

  // Regulators + government
  node("EOHHS","MA Executive Office of Health & Human Services (EOHHS)","Government & Regulators",
`WHAT THIS IS
- A state government office that oversees major health and human services programs (including MassHealth).

WHAT THEY DO
- Sets statewide health strategy and priorities.

WHAT THEY CARE ABOUT
- Budget stability and access
- Equity and public accountability
- Supporting programs that can scale safely`),

  node("HPC","Health Policy Commission (HPC)","Government & Regulators",
`WHAT THIS IS
- A state agency focused on healthcare cost growth.

WHAT THEY DO
- Tracks cost trends and can review major expansions/changes.

WHAT THEY CARE ABOUT
- Keeping cost growth sustainable
- Protecting access and quality
- Evidence that new models improve value (outcomes per dollar)`),

  node("CHIA","Center for Health Information & Analysis (CHIA)","Government & Regulators",
`WHAT THIS IS
- A state agency that publishes public data on healthcare spending and use.

WHAT THEY DO
- Produces reports so the public can see where money goes and how care is used.

WHAT THEY CARE ABOUT
- Clear measurement and transparency
- Comparable data across the system
- Strong evaluation plans for new programs`),

  node("DPH","MA Department of Public Health (DPH)","Government & Regulators",
`WHAT THIS IS
- The state public health department.

WHAT THEY DO
- Prevention programs, public health planning, and some oversight.

WHAT THEY CARE ABOUT
- Population health outcomes (like overdose prevention)
- Prevention and community-based impact
- Readiness for health emergencies`),

  node("DOI","MA Division of Insurance (DOI)","Government & Regulators",
`WHAT THIS IS
- The state office that regulates insurance.

WHAT THEY DO
- Reviews rules and protects consumers in the insurance market.

WHAT THEY CARE ABOUT
- Fairness and market stability
- Consumer protections
- Network access and clear plan rules`),

  // Community clinics / safety net
  node("CHCs","Community Health Centers (CHCs)","Community Clinics & Safety-Net Care",
`WHAT THIS IS
- Local clinics that provide primary care and supports, often for people with fewer resources.

WHAT THEY DO
- Primary care, prevention, and practical supports (like help with insurance or referrals).

WHAT THEY CARE ABOUT
- Keeping care accessible and trusted
- Preventing crises through continuity
- Partnerships that bring additional services to the community`),

  node("CHA","Cambridge Health Alliance (CHA)","Community Clinics & Safety-Net Care",
`WHAT THIS IS
- A health system with a strong community and safety-net focus.

WHAT THEY DO
- Primary care, hospital care, emergency care, and community programs.

WHAT THEY CARE ABOUT
- Access and equity
- Integrated mental health + medical care
- Preventing avoidable emergencies and admissions`),

  node("BHCHP","Boston Health Care for the Homeless Program (BHCHP)","Community Clinics & Safety-Net Care",
`WHAT THIS IS
- A program focused on medical and behavioral healthcare for people experiencing homelessness.

WHAT THEY DO
- Clinic and outreach-based care plus wraparound supports.

WHAT THEY CARE ABOUT
- Reducing crises and improving stability
- Trust-based, trauma-informed care
- Practical coordination across services`),

  // Behavioral health
  node("BH","Mental Health Providers","Mental Health & Substance Use Care",
`WHAT THIS IS
- Therapy, psychiatry, and crisis services (outpatient and inpatient).

WHAT THEY DO
- Helps people with depression, anxiety, severe mental illness, and more.

WHAT THEY CARE ABOUT
- More capacity and shorter waits
- Integration with primary care
- Sustainable funding for relationship-based care`),

  node("SUD","Substance Use Treatment & Recovery","Mental Health & Substance Use Care",
`WHAT THIS IS
- Treatment and support for substance use disorders (including recovery services and harm reduction).

WHAT THEY DO
- Helps prevent overdose and supports long-term recovery.

WHAT THEY CARE ABOUT
- Fast access to care
- Stable, long-term funding
- Warm handoffs between ER/clinics and recovery supports`),

  // Post-acute / LTSS
  node("PostAcute","Rehab, Nursing Facilities, Home Care","Rehab, Nursing, Home Care & Long-Term Supports",
`WHAT THIS IS
- Services that help people recover or live safely after a hospital stay (or with ongoing needs).

WHAT THEY DO
- Rehab, skilled nursing, home health, caregiver support.

WHAT THEY CARE ABOUT
- Smooth transitions from hospital to home
- Preventing readmissions
- Workforce and capacity stability`),

  // Industry
  node("Biotech","Biotech / Pharma / Medical Devices (MA cluster)","Biotech / Pharma / Medical Devices",
`WHAT THIS IS
- Companies building medicines and devices.

WHAT THEY DO
- Research, trials, and bringing products to market.

WHAT THEY CARE ABOUT
- Proof of safety and effectiveness
- Coverage and adoption
- Real-world evidence (how care works outside trials)`),

  // Employers
  node("Employers","Employers (who buy insurance for workers)","Employers (People Who Buy Insurance for Workers)",
`WHAT THIS IS
- Organizations that choose and pay for employee health plans.

WHAT THEY DO
- Select insurance options and benefits.

WHAT THEY CARE ABOUT
- Affordable, predictable costs
- Healthy, productive workforce
- Benefits that are easy to use and show results`),

  // People & workforce
  node("Patients","Patients & Families","Patients, Families & Frontline Clinicians",
`WHAT THIS IS
- People who need care and the families supporting them.

WHAT THEY DO
- Navigate appointments, medications, symptoms, and costs.

WHAT THEY CARE ABOUT
- Feeling better and functioning day-to-day
- Respect, dignity, and affordability
- Simple navigation (less paperwork, fewer dead ends)`),

  node("Clinicians","Frontline Clinicians (doctors, nurses, community health workers, therapists)","Patients, Families & Frontline Clinicians",
`WHAT THIS IS
- The people who deliver care every day.

WHAT THEY DO
- Diagnose, treat, support, and coordinate care.

WHAT THEY CARE ABOUT
- Enough time with patients
- Less administrative burden
- Support to prevent burnout and improve quality`),

  // Nonprofits (added)
  node("CCH","Center for Comprehensive Healing (CCH)","Nonprofits & Philanthropy",
`WHAT THIS IS
- A nonprofit collaboration (founded in 2025) between Mass General Brigham and the Shah Family Foundation.

MISSION (plain language)
- Advance whole-person healing through:
  1) research (show what works),
  2) medical education (teach clinicians),
  3) expanded access to care in underserved communities.

WHAT CCH CARES ABOUT
- Better outcomes people can feel (pain, stress, function, quality of life)
- Access and equity (underserved communities)
- Practical evidence that can scale (not just “nice ideas”)`),

  node("SFF","Shah Family Foundation","Nonprofits & Philanthropy",
`WHAT THIS IS
- A philanthropic foundation that supports mission-driven work.

WHAT THEY DO
- Fund and partner to build programs that improve lives.

WHAT THEY CARE ABOUT
- Impact and equity
- Programs that can scale and last
- Learning and transparency about what works`),

  node("Nonprofits","Other Health Nonprofits (advocacy, community orgs)","Nonprofits & Philanthropy",
`WHAT THIS IS
- Community organizations and nonprofits that fill gaps the medical system doesn’t cover well.

WHAT THEY DO
- Services like navigation help, food support, housing advocacy, peer support.

WHAT THEY CARE ABOUT
- Trust and access
- Practical help that prevents crises
- Strong partnerships with clinics and payers`)
];

function node(id,label,cat,details){
  return { id, label, cat, details };
}

/* --- Links (lines) --- */
const links = [
  // Money / payment
  link("BCBSMA","MGB","Insurance pays hospitals/clinics","payment", 2),
  link("BCBSMA","BILH","Insurance pays hospitals/clinics","payment", 1),
  link("Point32","TuftsMed","Insurance pays hospitals/clinics","payment", 1),
  link("Point32","BILH","Insurance pays hospitals/clinics","payment", 1),
  link("MassHealth","CHCs","MassHealth pays community clinics","payment", 2),
  link("MassHealth","CHA","MassHealth pays safety-net care","payment", 2),
  link("MassHealth","MGB","MassHealth pays covered care","payment", 1),
  link("Medicare","MGB","Medicare pays covered care","payment", 1),
  link("Medicare","PostAcute","Medicare pays rehab/home care","payment", 1),
  link("Employers","BCBSMA","Employers buy plans","payment", 1),
  link("Employers","Point32","Employers buy plans","payment", 1),

  // Rules / oversight
  link("HPC","MGB","Watches cost growth / major changes","policy", 2),
  link("HPC","BILH","Watches cost growth / major changes","policy", 1),
  link("HPC","BCBSMA","Tracks system-wide cost trends","policy", 1),
  link("DOI","BCBSMA","Insurance market rules","policy", 1),
  link("DOI","Point32","Insurance market rules","policy", 1),
  link("EOHHS","MassHealth","State strategy + program direction","policy", 2),
  link("DPH","SUD","Public health programs","policy", 1),
  link("DPH","BH","Public health programs","policy", 1),

  // Data / reporting
  link("CHIA","BCBSMA","Public reporting on spending/use","data", 1),
  link("CHIA","MassHealth","Public reporting on spending/use","data", 1),
  link("CHIA","MGB","Public reporting on system performance","data", 1),

  // Care / referrals (how people move through care)
  link("Clinicians","Patients","Care and trust relationship","care", 2),
  link("CHCs","Patients","Primary care + support services","care", 2),
  link("CHA","Patients","Primary care + hospital + ER","care", 2),
  link("BHCHP","Patients","Outreach + clinic-based care","care", 2),
  link("BH","Patients","Mental health care","care", 1),
  link("SUD","Patients","Treatment + recovery supports","care", 1),
  link("MGB","Patients","Specialty/hospital care when needed","care", 1),
  link("BILH","Patients","Hospital + outpatient care","care", 1),
  link("TuftsMed","Patients","Hospital + outpatient care","care", 1),
  link("PostAcute","Patients","Recovery + long-term supports","care", 1),

  // Integration points
  link("CHCs","BH","Referrals + shared care","care", 1),
  link("CHA","BH","Referrals + shared care","care", 1),
  link("MGB","BH","Specialty consults + referrals","care", 1),
  link("MGB","PostAcute","Discharge to rehab/home care","care", 1),
  link("BILH","PostAcute","Discharge to rehab/home care","care", 1),
  link("TuftsMed","PostAcute","Discharge to rehab/home care","care", 1),

  // Research / industry
  link("Biotech","MGB","Research and clinical trials","industry", 1),
  link("Biotech","DFCI","Research and clinical trials","industry", 1),
  link("Biotech","BCH","Research and clinical trials","industry", 1),

  // Nonprofit partnerships (added)
  link("CCH","MGB","Nonprofit collaboration (whole-person healing)","nonprofit", 2),
  link("SFF","CCH","Philanthropic partnership + support","nonprofit", 2),
  link("CCH","CHCs","Expand whole-person services in underserved communities","nonprofit", 2),
  link("CCH","BH","Integrate whole-person approaches with mental health care","nonprofit", 1),
  link("CCH","Patients","Programs designed around outcomes people feel","nonprofit", 1),
  link("Nonprofits","CHCs","Community supports and navigation","nonprofit", 1),
  link("Nonprofits","BHCHP","Wraparound supports","nonprofit", 1)
];

function link(source,target,label,type,strength=1){
  return { source, target, label, type, strength };
}

/* =========================================================
   UI: category accordions + legend toggles
   ========================================================= */
const categoryAccordions = document.getElementById("categoryAccordions");
const legend = document.getElementById("legend");
const filtersState = new Map(CATEGORIES.map(c => [c.key, true]));

// Category accordions
for (const c of CATEGORIES){
  const el = document.createElement("details");
  el.open = false;
  const sum = document.createElement("summary");
  sum.innerHTML = `<span class="dot" style="background:${c.color}; margin-right:8px"></span>${c.key}`;
  const meta = document.createElement("div");
  meta.className = "meta";
  meta.innerHTML = `
    <div><b>What this group does:</b> ${escapeHtml(c.job)}</div>
    <div style="margin-top:6px"><b>What they care about:</b></div>
    <ul class="list">${c.incentives.map(x => `<li>${escapeHtml(x)}</li>`).join("")}</ul>
  `;
  el.appendChild(sum);
  el.appendChild(meta);
  categoryAccordions.appendChild(el);
}

// Legend chips as toggles
for (const c of CATEGORIES){
  const chip = document.createElement("span");
  chip.className = "chip";
  chip.dataset.cat = c.key;
  chip.innerHTML = `<span class="dot" style="background:${c.color}"></span><span>${c.key}</span>`;
  chip.addEventListener("click", () => {
    const cur = filtersState.get(c.key);
    filtersState.set(c.key, !cur);
    chip.style.opacity = (!cur) ? "1" : ".35";
    applyFilters();
  });
  legend.appendChild(chip);
}

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

/* =========================================================
   GRAPH RENDER (D3)
   ========================================================= */
const svg = d3.select("#svg");
const statusEl = document.getElementById("status");
const width = 1400, height = 900;

// Zoom container
const gZoom = svg.append("g");
const gLinks = gZoom.append("g");
const gLinkLabels = gZoom.append("g");
const gNodes = gZoom.append("g");
const gLabels = gZoom.append("g");

const zoom = d3.zoom()
  .scaleExtent([0.35, 3.0])
  .on("zoom", (event) => gZoom.attr("transform", event.transform));
svg.call(zoom);

// Rough “layered” initial positions
const preset = new Map([
  ["Government & Regulators", {x: 700, y: 120}],
  ["Insurance Companies (Commercial)", {x: 300, y: 260}],
  ["Government Coverage Programs", {x: 1100, y: 260}],
  ["Hospitals & Health Systems", {x: 900, y: 430}],
  ["Community Clinics & Safety-Net Care", {x: 480, y: 470}],
  ["Mental Health & Substance Use Care", {x: 280, y: 640}],
  ["Rehab, Nursing, Home Care & Long-Term Supports", {x: 930, y: 690}],
  ["Biotech / Pharma / Medical Devices", {x: 1180, y: 120}],
  ["Employers (People Who Buy Insurance for Workers)", {x: 120, y: 180}],
  ["Patients, Families & Frontline Clinicians", {x: 650, y: 800}],
  ["Nonprofits & Philanthropy", {x: 1020, y: 540}]
]);

nodes.forEach((n,i) => {
  const p = preset.get(n.cat) || {x:700,y:450};
  n.x = p.x + (Math.cos(i)*70);
  n.y = p.y + (Math.sin(i)*40);
});

// Force simulation
let sim = d3.forceSimulation(nodes)
  .force("link", d3.forceLink(links).id(d => d.id).distance(170).strength(d => 0.6 + (d.strength*0.08)))
  .force("charge", d3.forceManyBody().strength(-620))
  .force("center", d3.forceCenter(width/2, height/2))
  .force("collide", d3.forceCollide().radius(d => 34).iterations(2));

// Links (color-coded by link type)
const linkSel = gLinks.selectAll("line")
  .data(links)
  .join("line")
  .attr("class", d => {
    const css = linkTypeCss.get(d.type) || "";
    return "link " + css + (d.strength >= 2 ? " strong" : "");
  });

// Link labels (match link type color, readable halo)
const linkLabelSel = gLinkLabels.selectAll("text")
  .data(links)
  .join("text")
  .attr("class", d => "linkLabel " + (linkTypeCss.get(d.type) || ""))
  .text(d => d.label);

// Nodes
const nodeSel = gNodes.selectAll("g")
  .data(nodes)
  .join("g")
  .attr("class","node")
  .call(d3.drag()
    .on("start", dragstarted)
    .on("drag", dragged)
    .on("end", dragended)
  )
  .on("click", (_, d) => selectNode(d));

nodeSel.append("circle")
  .attr("r", 22)
  .attr("fill", d => catColor(d.cat))
  .attr("opacity", 0.95);

// Labels
const labelSel = gLabels.selectAll("text")
  .data(nodes)
  .join("text")
  .attr("class","label")
  .attr("text-anchor","middle")
  .attr("dy", 4)
  .text(d => shortLabel(d.label));

function shortLabel(s){
  return s.length > 26 ? s.slice(0, 24) + "…" : s;
}

// Simulation tick
sim.on("tick", () => {
  linkSel
    .attr("x1", d => d.source.x).attr("y1", d => d.source.y)
    .attr("x2", d => d.target.x).attr("y2", d => d.target.y);

  nodeSel.attr("transform", d => `translate(${d.x},${d.y})`);

  labelSel
    .attr("x", d => d.x)
    .attr("y", d => d.y + 40);

  linkLabelSel
    .attr("x", d => (d.source.x + d.target.x)/2)
    .attr("y", d => (d.source.y + d.target.y)/2 - 8);
});

function dragstarted(event, d){
  if (!event.active) sim.alphaTarget(0.2).restart();
  d.fx = d.x; d.fy = d.y;
}
function dragged(event, d){
  d.fx = event.x; d.fy = event.y;
}
function dragended(event, d){
  if (!event.active) sim.alphaTarget(0);
  d.fx = null; d.fy = null;
}

/* =========================================================
   Selection + highlighting connections
   ========================================================= */
const selCat = document.getElementById("selCat");
const selTitle = document.getElementById("selTitle");
const selBody = document.getElementById("selBody");
const selConn = document.getElementById("selConn");

let selectedId = null;

function selectNode(d){
  selectedId = d.id;
  selCat.textContent = d.cat;
  selTitle.textContent = d.label;
  selBody.textContent = d.details || "";

  // Compute neighbors and connection types
  const incident = links.filter(l =>
    l.source.id ? (l.source.id===d.id || l.target.id===d.id)
                : (l.source===d.id || l.target===d.id)
  );
  const neighbors = new Set();
  const byType = new Map();
  for (const l of incident){
    const s = (l.source.id || l.source), t = (l.target.id || l.target);
    const other = (s === d.id) ? t : s;
    neighbors.add(other);
    byType.set(l.type, (byType.get(l.type)||0)+1);
  }

  const neighborLabels = [...neighbors].map(id => nodes.find(n => n.id===id)?.label || id);

  const typePretty = t => (LINK_TYPES.find(x => x.key===t)?.label || t);

  selConn.innerHTML =
    `<b>Connections:</b> ${incident.length} lines<br/>
     <b>Connected to:</b> ${neighborLabels.length ? neighborLabels.join(" • ") : "—"}<br/>
     <b>Line types:</b> ${[...byType.entries()].map(([k,v]) => `${typePretty(k)} (${v})`).join(" • ") || "—"}`;

  // Highlight: keep selected + neighbors bright, fade others
  nodeSel.select("circle")
    .classed("selected", n => n.id === d.id)
    .classed("faded", n => !(n.id===d.id || neighbors.has(n.id)));

  labelSel.classed("faded", n => !(n.id===d.id || neighbors.has(n.id)));

  linkSel
    .classed("faded", l => {
      const s = (l.source.id || l.source), t = (l.target.id || l.target);
      return !(s===d.id || t===d.id);
    });

  linkLabelSel
    .attr("opacity", l => {
      const s = (l.source.id || l.source), t = (l.target.id || l.target);
      return (s===d.id || t===d.id) ? 1.0 : 0.15;
    });

  statusEl.textContent = `Selected: ${d.id}`;
}

// Clear selection
document.getElementById("clearSelBtn").addEventListener("click", clearSelection);
function clearSelection(){
  selectedId = null;
  selCat.textContent = "none";
  selTitle.textContent = "Nothing selected";
  selBody.innerHTML = `<span style="color:var(--muted)">Click a circle to open details here.</span>`;
  selConn.innerHTML = "";
  nodeSel.select("circle").classed("selected", false).classed("faded", false);
  labelSel.classed("faded", false);
  linkSel.classed("faded", false);
  linkLabelSel.attr("opacity", 1.0);
  statusEl.textContent = "Ready";
}

/* =========================================================
   Filters by category
   ========================================================= */
function applyFilters(){
  const visible = d => filtersState.get(d.cat) !== false;

  nodeSel.style("display", d => visible(d) ? null : "none");
  labelSel.style("display", d => visible(d) ? null : "none");

  linkSel.style("display", l => (visible(l.source) && visible(l.target)) ? null : "none");
  linkLabelSel.style("display", l => (visible(l.source) && visible(l.target)) ? null : "none");

  // If selection is hidden, clear it
  if (selectedId){
    const d = nodes.find(n => n.id===selectedId);
    if (d && !visible(d)) clearSelection();
  }
}

/* =========================================================
   Search highlighting
   ========================================================= */
const search = document.getElementById("search");
search.addEventListener("input", () => {
  const q = search.value.trim().toLowerCase();
  if (!q){
    nodeSel.select("circle").attr("opacity", 0.95);
    labelSel.attr("opacity", 1.0);
    linkSel.attr("opacity", 1.0);
    linkLabelSel.attr("opacity", 1.0);
    return;
  }
  nodeSel.select("circle").attr("opacity", d => {
    const hit = (d.label + " " + d.id + " " + d.cat + " " + (d.details||"")).toLowerCase().includes(q);
    return hit ? 1.0 : 0.22;
  });
  labelSel.attr("opacity", d => {
    const hit = (d.label + " " + d.id + " " + d.cat + " " + (d.details||"")).toLowerCase().includes(q);
    return hit ? 1.0 : 0.22;
  });
  linkSel.attr("opacity", l => {
    const s = (l.source.label||l.source.id||l.source), t = (l.target.label||l.target.id||l.target);
    const hit = (String(s)+" "+String(t)+" "+l.label+" "+l.type).toLowerCase().includes(q);
    return hit ? 1.0 : 0.15;
  });
  linkLabelSel.attr("opacity", l => {
    const s = (l.source.label||l.source.id||l.source), t = (l.target.label||l.target.id||l.target);
    const hit = (String(s)+" "+String(t)+" "+l.label+" "+l.type).toLowerCase().includes(q);
    return hit ? 1.0 : 0.15;
  });
});

/* =========================================================
   View controls
   ========================================================= */
document.getElementById("resetBtn").addEventListener("click", () => {
  svg.transition().duration(350).call(zoom.transform, d3.zoomIdentity);
  search.value = ""; search.dispatchEvent(new Event("input"));
  // Re-seed positions near presets and restart
  nodes.forEach((n,i) => {
    const p = preset.get(n.cat) || {x:700,y:450};
    n.x = p.x + (Math.cos(i)*70);
    n.y = p.y + (Math.sin(i)*40);
  });
  sim.alpha(0.75).restart();
  clearSelection();
  applyFilters();
});

document.getElementById("fitBtn").addEventListener("click", fitToScreen);
function fitToScreen(){
  // Compute bounds of visible nodes
  const visibleNodes = nodes.filter(n => filtersState.get(n.cat) !== false);
  if (!visibleNodes.length) return;
  const xs = visibleNodes.map(n => n.x), ys = visibleNodes.map(n => n.y);
  const minX = Math.min(...xs), maxX = Math.max(...xs);
  const minY = Math.min(...ys), maxY = Math.max(...ys);
  const pad = 120;
  const vbW = 1400, vbH = 900;
  const boxW = (maxX - minX) + pad*2;
  const boxH = (maxY - minY) + pad*2;
  const scale = Math.min(vbW/boxW, vbH/boxH);
  const tx = (vbW/2) - scale*(minX + maxX)/2;
  const ty = (vbH/2) - scale*(minY + maxY)/2;
  svg.transition().duration(350).call(zoom.transform, d3.zoomIdentity.translate(tx, ty).scale(scale));
}

document.getElementById("freezeBtn").addEventListener("click", (e) => {
  const btn = e.currentTarget;
  const frozen = btn.dataset.freeze === "1";
  if (!frozen){
    sim.stop();
    btn.dataset.freeze = "1";
    btn.textContent = "Unfreeze layout";
    statusEl.textContent = "Layout frozen";
  } else {
    sim = d3.forceSimulation(nodes)
      .force("link", d3.forceLink(links).id(d => d.id).distance(170).strength(d => 0.6 + (d.strength*0.08)))
      .force("charge", d3.forceManyBody().strength(-620))
      .force("center", d3.forceCenter(width/2, height/2))
      .force("collide", d3.forceCollide().radius(d => 34).iterations(2))
      .on("tick", () => {
        linkSel
          .attr("x1", d => d.source.x).attr("y1", d => d.source.y)
          .attr("x2", d => d.target.x).attr("y2", d => d.target.y);
        nodeSel.attr("transform", d => `translate(${d.x},${d.y})`);
        labelSel.attr("x", d => d.x).attr("y", d => d.y + 40);
        linkLabelSel.attr("x", d => (d.source.x + d.target.x)/2).attr("y", d => (d.source.y + d.target.y)/2 - 8);
      });
    btn.dataset.freeze = "0";
    btn.textContent = "Freeze layout";
    statusEl.textContent = "Ready";
  }
});

/* =========================================================
   Initial
   ========================================================= */
applyFilters();
fitToScreen();


</script>
</body>
</html>
